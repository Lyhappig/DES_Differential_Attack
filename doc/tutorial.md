## DES概述

DES算法分组长度为64比特，密钥长度为56比特，属于Feistel结构密码，迭代轮数为16轮。加密流程如图1所示。

<img src="https://cdn.jsdelivr.net/gh/Lyhappig/images/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0:%E5%AF%86%E7%A0%81%E5%AD%A6:%E5%AF%86%E7%A0%81%E5%88%86%E6%9E%90:%E5%B7%AE%E5%88%86%E5%88%86%E6%9E%90:DES%E5%B7%AE%E5%88%86%E5%88%86%E6%9E%90.png" style="zoom: 50%;" />

<center><text><b>图1 DES加密结构图</b></text></center>

1. 64比特的明文 $X=x_1, x_2, ..., x_{64}$ 先经过初始置换 $IP$ 获得 $IP(X)$

2. 令 $IP(X)=L_0R_0$，其中 $L_0$ 为 $IP(X)$ 的左半部分32比特，$R_0$ 为 $IP(X)$ 的右半部分32比特。将 $L_0R_0$ 按照如下方式迭代16轮，得到 $L_{16}R_{16}$

   $\left\{
   \begin{aligned}
   L_i & = R_{i-1}, \\
   R_i & = L_{i-1} \oplus F(R_{i-1}, K_i),
   \end{aligned}
   \right. ~~~~1 \leq i \leq 16
   $

   其中 $F$ 表示轮函数，$K_i$ 表示第 $i$ 轮的轮密钥

3. 对 $R_{16}L_{16}$ 应用初始逆置换 $IP^{-1}$，得到密文 $Y=IP^{-1}(R_{16}L_{16})$

DES的轮函数 $F$ 如下图2所示：

<img src="https://cdn.jsdelivr.net/gh/Lyhappig/images/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0:%E5%AF%86%E7%A0%81%E5%AD%A6:%E5%AF%86%E7%A0%81%E5%88%86%E6%9E%90:%E5%B7%AE%E5%88%86%E5%88%86%E6%9E%90:DES%E5%B7%AE%E5%88%86%E5%88%86%E6%9E%90-2.png" style="zoom: 33%;" />

<center><text><b>图2 DES轮函数</b></text></center>

注意，最后一轮采用 $R_{16}L_{16}$ 的原因是为了保持Feistel结构的对称性。因为默认迭代16轮，迭代时每一轮都对输出做了交叉，所以这里要交换。当然也可以迭代15轮，最后一轮不交叉，这样进行 $IP^{-1}$ 时就可以采用 $L_{16}R_{16}$ 了。

## 差分分析

### S盒的差分分布表

设 $m, n\in \mathbb{N}$，从 $\mathbb{F}_2^m$ 到 $\mathbb{F}_2^n$ 的非线性映射（也称为S盒）记为：$S:\mathbb{F}_2^m \rightarrow \mathbb{F}_2^n$ ，给定 $\alpha \in \mathbb{F}_2^m, \beta \in \mathbb{F}_2^n$，定义：

$IN_S(\alpha, \beta) = \{x \in \mathbb{F}_2^m:S(x \oplus \alpha) \oplus S(x) = \beta \}$

$N_S(\alpha, \beta) = \#IN_S(\alpha, \beta)$ ，这里 # 指取集合的大小

以 $\alpha$ 为行指标遍历 $\mathbb{F}_2^m$，$\beta$ 为列指标遍历 $\mathbb{F}_2^n$，行列交错的地方取值 $N_S(\alpha, \beta)$ ，构造的 $2^m \times 2^n$ 的表格如表1所示（以DES的第一个 $S$ 盒为例）。称 $\alpha$ 为 $S$ 盒的输入差分，$\beta$ 为 $S$ 盒的输出差分，三元组 $(\alpha, \beta, N_S(\alpha, \beta))$ 按上述方式构成的表为 $S$ 盒的差分分布表。

<center><text><b>表1 DES第一个S盒的差分分布表</b></text></center>

<img src="https://cdn.jsdelivr.net/gh/Lyhappig/images/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0:%E5%AF%86%E7%A0%81%E5%AD%A6:%E5%AF%86%E7%A0%81%E5%88%86%E6%9E%90:%E5%B7%AE%E5%88%86%E5%88%86%E6%9E%90:DES%E5%B7%AE%E5%88%86%E5%88%86%E6%9E%90-3_%E5%89%AF%E6%9C%AC.png" style="zoom: 50%;" />

$S$ 盒差分分布表的第 $\alpha$ 行第 $\beta$ 列取值 $N_S(\alpha, \beta)$ 表示：对固定的 $\alpha \in \mathbb{F}_2^m, \beta \in \mathbb{F}_2^n$，当 $x$ 遍历 $\mathbb{F}_2^m$ 时，可以得到 $2^m$ 个输入对 $(x, x \oplus \alpha)$，这些输入对中，能够使 $S(x) \oplus S(x \oplus \alpha)$ 成立的个数为 $N_S(\alpha, \beta)$。$N_S(\alpha, \beta)$ 的取值根据方程 $S(x) \oplus S(x \oplus \alpha) = \beta$ 根的数目给出。若方程无解，则 $N_S(\alpha, \beta)=0$；若 $x$ 为其中的一个解，那么 $x \oplus \alpha$ 为另一个解，故 $N_S(\alpha, \beta)$ 为偶数。

固定 $\alpha \in \mathbb{F}_2^m$，当 $x$ 遍历 $\mathbb{F}_2^m$ 时，分别计算 $S(x) \oplus S(x \oplus \alpha)$ ，则一共可以得到 $2^m$ 个值，这些值会以某种方式分布在 $\mathbb{F}_2^n$ 上。$S$ 盒的差分分布表中，每一行之和为 $2^m$，即 $\sum_\limits{\beta \in \mathbb{F}_2^n} N_S(\alpha, \beta) = 2^m$，且表中项的平均取值为 $2^{m-n}$，令：

$P_S(\alpha \rightarrow \beta) = \Pr_\limits{X \in \mathbb{F}_2^m}(S(X) \oplus S(X \oplus \alpha) = \beta) = \frac{N_S(\alpha, \beta)}{2^m}$

故 $\sum_\limits{\beta \in \mathbb{F}_2^n} P_S(\alpha \rightarrow \beta) = 1$。所以从概率统计的角度讲，随机（满足均匀分布）给定输入对为 $(x, x \oplus \alpha)$，经过 $S$ 盒后，输出差分将以概率 $P_S(\alpha \rightarrow \beta)$ 得到 $S(x) \oplus S(x \oplus \alpha) = \beta$。

通过集合 $IN_S(\alpha, \beta)$ 就可以确定哪些具体的输入 $x$ 会导致输入差分 $\alpha$ 会传播到输出差分 $\beta$，这一点对于低轮次的 DES 算法差分分析至关重要。

**$S$ 盒的差分分布表反映了随机输入对经过它得到的输出对的差分分布特性，这一点和线性映射区分开来**

考虑 $8$ 个 $S$ 盒，其中每个 $S$ 盒的差分分布表中，对于一个给定的输入差分，所以可能的输出差分大概只出现 $75\% \sim80\%$，即 16 个输出差分一般只有 12 个左右非零。

### 攻击S盒的流程

考虑对密码组件 $S$ 盒的攻击，如下图3所示：

<img src="https://cdn.jsdelivr.net/gh/Lyhappig/images/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0:%E5%AF%86%E7%A0%81%E5%AD%A6:%E5%AF%86%E7%A0%81%E5%88%86%E6%9E%90:%E5%B7%AE%E5%88%86%E5%88%86%E6%9E%90:DES%E5%B7%AE%E5%88%86%E5%88%86%E6%9E%90-6.png" style="zoom: 33%;" />

<center><text><b>图3</b></text></center>

这里 $x$ 为明文输入，$k$ 为密钥，$z=x \oplus k$ 为 $S$ 盒的输入， $S$ 盒的输出 $y = S(x \oplus k)$ 为密文。假设攻击者可以获得明文和相应密文，希望恢复密钥。这时只需要查表得到输入 $z$ 的4个候选值，然后枚举来验证。

#### $S$ 盒的差分分析

采用上图所示的加密模型。攻击者可以选择若干个明文，但是不能获得对应密文，只能观察到某两个密文的差分，即攻击者可以获得若干三元组 $(x_i, x_j, y_i \oplus y_j)$，由此获得密钥的若干信息。

对 $S$ 盒的差分攻击主要利用性质：$(x \oplus k) \oplus (x^* \oplus k) = x \oplus x^*$，恢复密钥要用到集合 $IN_S(\alpha, \beta)$。

观察表1，注意到当输入差分 $\alpha = 34_x$ 时，输出差分共有 8 种可能性。表2给出了输出差分为 $\alpha = 34_x$，各个输出差分的 $N_S(\alpha, \beta)$ 的取值情况。

<center><text><b>表2</b></text></center>

![](https://cdn.jsdelivr.net/gh/Lyhappig/images/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0:%E5%AF%86%E7%A0%81%E5%AD%A6:%E5%AF%86%E7%A0%81%E5%88%86%E6%9E%90:%E5%B7%AE%E5%88%86%E5%88%86%E6%9E%90:DES%E5%B7%AE%E5%88%86%E5%88%86%E6%9E%90-4.png)

接下来的表3给出了 $34_x \rightarrow \beta$ 时，集合 $IN_S(34_x, D_x)$ 的取值分布：

<center><text><b>表3</b></text></center>

| 输出差分 $\beta$ |                 $IN_S(\alpha, \beta)$                 | $N_S(\alpha, \beta)$ |
| :--------------: | :---------------------------------------------------: | :------------------: |
|      $1_x$       |             $\{03,37|0F,3B|1E,2A|1F,2B\}$             |          8           |
|      $2_x$       | $\{04,30|05,31|0E,3A|11,25|12,26|14,20|1A,2E|1B,2F\}$ |          16          |
|      $3_x$       |                $\{01,35|02,36|15,21\}$                |          6           |
|      $4_x$       |                      $\{13,27\}$                      |          2           |
|      $7_x$       |     $\{00,34|08,3C|0D,39| 17,23| 18,2C| 1D,29\}$      |          12          |
|      $8_x$       |              $\{09,3D |0C,38| 19,2D \}$               |          6           |
|      $D_x$       |           $\{06,32 |10,24| 16,22| 1C,28\}$            |          8           |
|      $F_x$       |               $\{07,33 |0A,3E| 0B,3F\}$               |          6           |
|       其他       |                     $\varnothing$                     |          0           |

假设现在加密采用的密钥为 $k=23_x$

若已知一对明文输入为 $x_1 = 1_x, x_1^*=35_x$，则加密的输出差分为 $D_x$。攻击者可以计算 $S_1$ 的输入差分 $z_1 \oplus z_1^*=(x_1 \oplus x_1^*)=34_x$，根据上表可以获取到集合 $IN_S(34_x, D_x)$，则：

$z_1 = x_1 \oplus k \in \{06, 32 | 10, 24 | 16,22 | 1C, 28\}$，竖线分隔的每一对输入的差分均为 $34_x$

这样就可以得到 $k$ 的一组候选值集合，即 $k = z_1 \oplus x_1 \in \{07, 11,17,1D,33,25,23, 29\}=K_1$

这时攻击者获得了另外一对明文输入 $x_2 = 21_x, x_2^*=15_x$，观察到密文对的输出差分 $\beta= y_2 \oplus y_2^*=3_x$，根据表3获取集合 $IN_S(34_x, 3_x)$，即 $z_2 = x_2 \oplus k \in\{01,35|02,36|15,21\}$

这样得到了 $k$ 的第二组候选值集合 $k=z_2 \oplus x_2 \in \{20,14,23,17,34,00\}=K_2$

正确的密钥 $k$ 一定落在上述两组密钥候选值集合的交集中，即 $k \in K_1 \cap K_2=\{17_x, 23_x\}$

**注意**：因为此时密钥候选值交集满足 $17_x \oplus 23_x=34_x=\alpha$，此时再选择新的三元组也无法筛选出正确密钥。因为设正确密钥值为 $k$，则错误密钥值就为 $k \oplus 34_x$，这两种情况下，$S_1$ 的输入对分别为 $(x_3 \oplus k, x_3^* \oplus k),(x_3 \oplus k \oplus 34_x, x_3^* \oplus k \oplus 34_x)=(x_3^* \oplus k, x_3 \oplus k)$。因此需要其他的三元组 $(x, x^*, y \oplus y^*)$，且满足 $x \oplus x^* \neq 0_x, 34_x$

## 低轮次差分分析

因为初始置换和最后的逆置换不影响差分攻击的结果，因此如下差分分析的过程，将初始置换和最后的逆置换移除出 DES 的结构中。

即使是低轮次的密码，也要保证其DES的结构和正常加解密。那么DES的迭代差分特征就是输入差分等于输出差分左右两部分的交换。**交换后才能作为一个中间轮次进行多次差分特征的级联**。

<img src="https://cdn.jsdelivr.net/gh/Lyhappig/images/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0:%E5%AF%86%E7%A0%81%E5%AD%A6:%E5%AF%86%E7%A0%81%E5%88%86%E6%9E%90:%E5%B7%AE%E5%88%86%E5%88%86%E6%9E%90:DES%E5%B7%AE%E5%88%86%E5%88%86%E6%9E%90-2.png" style="zoom: 33%;" />

若攻击轮数为 $n$，记第 $i$ 轮轮函数的输入对为 $(L_i,R_i),(L_i^*, R_i^*),0 \leq i \leq n$，其中 $i=0$ 时代表明文对，$i=n$ 时代表密文对；

记轮函数 $F$ 的符号为 $f(., .)$，轮函数扩展置换为 $E$，轮函数置换为 $P$，扩展置换的逆置换为 $P^{-1}$；

记 8 个 $S$ 盒的符号为 $S_1,S_2,...,S_8$；

记第 $i$ 轮 $S$ 盒的输入为 $B_i=B_{i,1}B_{i,2}B_{i,3}B_{i,4}B_{i,5}B_{i,6}B_{i,7}B_{i,8}$，输出为 $C_i=C_{i,1}C_{i,2}C_{i,3}C_{i,4}C_{i,5}C_{i,6}C_{i,7}C_{i,8}$，其中 $B_{i,j}$ 为 6 比特的串，$C_{i,j}$ 为 4 比特的串；

记 $S$ 盒的候选密钥集符号为 $J=J_1J_2J_3J_4J_5J_6J_7J_8$，其中 $J_i$ 为 6 比特的串；

记差分为符号右上角的 $'$，如 $L', R',B_i',C_{i,j}'$。

### 1-2轮差分分析

因为DES的轮函数里只有 $S$ 盒是非线性变换，其余的线性变换均不影响差分。因此一轮的差分分析实际上是对轮函数 $S$ 盒的攻击，按照上面攻击 $S$ 盒的方式并结合轮函数的结构进行攻击。

对于2轮的差分分析，同样可以转化为对 $S$ 盒的攻击：设 $L_0'=0$，那么密文差分的右半部分对应第一轮的轮函数的输出差分，同理对 $S$ 盒进行攻击。

### 3轮差分分析

假设图4是本次分析过程中的3轮DES结构图。

<img src="https://cdn.jsdelivr.net/gh/Lyhappig/images/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0:%E5%AF%86%E7%A0%81%E5%AD%A6:%E5%AF%86%E7%A0%81%E5%88%86%E6%9E%90:%E5%B7%AE%E5%88%86%E5%88%86%E6%9E%90:DES%E5%B7%AE%E5%88%86%E5%88%86%E6%9E%90-7.png" style="zoom: 33%;" />

<center><text><b>图4</b></text></center>

设明文对为 $(L_0, R_0), (L_0^*, R_0^*)$，明文差分为 $(L_0', R_0')$；对应的密文分别为 $(R_3,L_3),(R_3^*, L_3^*)$，密文差分为 $(R_3', L_3')$

可以将 $R_3$ 表示为 $R_3 = L_2 \oplus f(R_2, K_3) = R_1 \oplus f(R_2, K_3)=L_0 \oplus f(R_0, K_1) \oplus f(R_2, K_3)$

同理 $R_3^* = L_0^* \oplus f(R_0^*, K_1) \oplus f(R_2^*, K_3)$

因此密文差分 $R_3'=R_3 \oplus R_3^*=L_0' \oplus f(R_0, K_1) \oplus f(R_2, K_3) \oplus f(R_0^*, K_1) \oplus f(R_2^*, K_3)$

假设我们选择明文使得 $R_0 = R_0^*$，即 $R_0'=0$，则 $R_3'=L_0' \oplus f(R_2, K_3) \oplus f(R_2^*, K_3)$

因为 $L_0, L_0^*, R_3, R_3^*$ 均为已知，所以 $R_3',L_0'$ 均可以计算出，这样 $f(R_2, K_3) \oplus f(R_2^*, K_3)=L_0' \oplus R_3'$

在第3轮的轮函数中，设 $C,C^*$ 是明文对经过S盒的非线性置换的输出，又因为最后一轮的轮函数置换 $P$ 是公开的，根据 $f(R_2, K_3)=P(C), f(R_2^*, k_3)=P(C^*),f(R_2, K_3) \oplus f(R_2^*, K_3)=L_0' \oplus R_3'$，注意到 $P$ 是置换，根据置换的性质 $P(x \oplus y)=P(x) \oplus P(y)$，得 $C'= C \oplus C^* = P^{-1}(L_0' \oplus R_3')$，这样得到了第三轮轮函数 $S$ 盒的输出和对应输出差分。

第3轮轮函数的输入 $R_2=L_3, R_2^* = L_3^*$，再根据轮函数的扩展置换 $E$，就得到了第三轮轮函数 $S$ 盒的输入 $B=E(L_3),B^*= E(L_3^*)$。

接下来我们通过对第三轮 $S$ 盒的攻击来获取第三轮的轮密钥：

1. 寻找若干个满足输入差分为 $(L_0',0)$ 的明文对，并计算出对应的密文差分 $(L_3', R_3')$
2. 计算 $C'=P^{-1}(R_3' \oplus L_0')$；计算 $B'=B \oplus B^*$，其中 $B=E(L_3),B^*=E(L_3^*)$
3. 通过建立 8 个具有 64 个计数器的计数矩阵，对于第 $i(1 \leq i \leq 8)$ 个 $S$ 盒，计算出第三轮的子密钥候选集合 $J=J_1J_2J_3J_4J_5J_6J_7J_8$，其中 $J_i \in KJ_i, KJ_i=IN_S(B', C') \oplus B$
4. 取每个计数矩阵上唯一等于明文对个数的值作为正确子密钥的部分比特，最终可以得到第三轮的子密钥 $K_3$。

### 4轮差分分析

对4轮的差分分析同样是对 $S$ 盒的差分分析，只是没办法分析完整的8个S盒，攻击流程如图5所示。

<img src="https://cdn.jsdelivr.net/gh/Lyhappig/images/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0:%E5%AF%86%E7%A0%81%E5%AD%A6:%E5%AF%86%E7%A0%81%E5%88%86%E6%9E%90:%E5%B7%AE%E5%88%86%E5%88%86%E6%9E%90:DES%E5%B7%AE%E5%88%86%E5%88%86%E6%9E%90-8.png" style="zoom: 50%;" />

<center><text><b>图5</b></text></center>

对第四轮的轮函数的 $S$ 盒进行差分分析。

1. 第四轮 $S$ 盒的输入差分可以由 $L_4'$ 得到。
2. 第四轮轮函数的输出差分为 $P(C_4')=R_4' \oplus L_3'=R_4' \oplus R_2' = R_4' \oplus L_1' \oplus C_1'=R_4' \oplus P(*0000000_x)$，根据置换 $P$ 的可逆性可以得到 $S$ 盒输出差分为 $C_4' = P^{-1}(R_4' \oplus P(*0000000_x))=P^{-1}(R_4') \oplus (*0000000_x)$
3. 通过上述相同的 $S$ 盒分析方法可以得到 $7*6=42$ 比特的子密钥，剩下 14 比特子密钥可以通过枚举来破解。

### 5轮差分分析

对五轮DES算法的差分攻击，就是在图5中再增加一轮，如图6所示。

<img src="https://cdn.jsdelivr.net/gh/Lyhappig/images/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0:%E5%AF%86%E7%A0%81%E5%AD%A6:%E5%AF%86%E7%A0%81%E5%88%86%E6%9E%90:%E5%B7%AE%E5%88%86%E5%88%86%E6%9E%90:DES%E5%B7%AE%E5%88%86%E5%88%86%E6%9E%90-9%E5%89%AF%E6%9C%AC.png" style="zoom:50%;" />

<center><text><b>图6</b></text></center>

注意到第3轮轮函数的输入差分为 $P(*0000000_x)$，根据扩展置换 $E$ 和 $P$ 置换的性质，第3轮轮函数的输出差分必定为 $P(0*0***00_x)$

从而得到第五轮轮函数的输出差分为 $P(C_5')=R_5' \oplus L_4' = R_5' \oplus R_3'=R_5' \oplus L_0' \oplus P(0*0***00_x)$，故第五轮 $S$ 盒输出 $C_5' = P^{-1}(R_5' \oplus L_0') \oplus (0*0***00_x)$

故第五轮的四个 $S$ 盒可求，接着只需要再枚举剩下的 32 比特即可攻破密钥。

## 高轮次差分分析

通过对4～5轮的攻击可以发现，攻击者利用 $S$ 盒的差分分布模型进行差分攻击的关键在于能够确定若干个非活跃 $S$ 盒对应的某些比特，通过令明文部分比特为0取适当的值，从而使得攻击的那一轮的某些比特完全确定。

当轮数超过 5 轮后，无法直接利用 $S$ 盒的差分分析模型完成攻击的原因在于中间状态的差分值无法确定，由于 $S$ 盒的扩散使得这些值是随机的。

但是这些中间状态的差分分布遵从一定的统计规律，即在明文取某个值时，经过若干轮之后，中间状态的某些差分值出现的概率比其他差分值出现的概率大，我们就可以通过构造差分特征，采用计数原理，利用统计学相关知识来恢复密钥的部分比特。

### 6轮差分分析

首先采用差分特征如图7所示：

<img src="https://cdn.jsdelivr.net/gh/Lyhappig/images/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0:%E5%AF%86%E7%A0%81%E5%AD%A6:%E5%AF%86%E7%A0%81%E5%88%86%E6%9E%90:%E5%B7%AE%E5%88%86%E5%88%86%E6%9E%90:DES%E5%B7%AE%E5%88%86%E5%88%86%E6%9E%90-10.png" style="zoom: 50%;" />

<center><text><b>图7</b></text></center>

选择明文满足 $L_0'=40080000_x$ 和 $R_0'=04000000_x$ 的明密文对 $(L_0R_0, L_6R_6)$ 和 $(L_0^*R_0^*, L_6^*R_6^*)$，$R_6$ 和 $R_6^*$ 可分别表示为：

$R_6 = L_5 \oplus f(R_5, K_6)=R_4 \oplus f(R_5, K_6)=L_3 \oplus f(R_3, K_4) \oplus f(R_5, K_6) \\ R_6^* = L_5^* \oplus f(R_5^*, K_6)=R_4^* \oplus f(R_5^*, K_6)=L_3^* \oplus f(R_3^*, K_4) \oplus f(R_5^*, K_6)$

因此有：

$R_6'=L_3' \oplus f(R_3, K_4) \oplus f(R_3^*, K_4) \oplus f(R_5, K_6)  \oplus f(R_5^*, K_6)$

$R_6'$ 是密文差分的左半部分，从上述构造的差分特征 $\Omega$ 中，由给定明文差分得到第三轮的密文差分的概率为 $1/16$。如果情况确实如此，那么第四轮 $S$ 盒的输入差分可以通过轮函数扩展 $E$ 计算得到：$001000 | 000000|000001|010000 |000000 |000000 |000000 |000000 $

观察到 $S_2, S_5, S_6, S_7, S_8$ 的输入差分全为 0，因此在第四轮中着五个 $S$ 盒的输出差分全为0。根据 $P(C_6')=f(R_5, K_6)  \oplus f(R_5^*, K_6), P(C_4')=f(R_3, K_4) \oplus f(R_3^*, K_4)$，代入 $R_6'$，可以得到：

$P(C_6')=R_6' \oplus L_3' \oplus P(C_4')$

故 $C_6'=P^{-1}(R_6' \oplus 04000000_x) \oplus (*0**0000_x)$

据此我们得到第 6 轮轮函数五个非活跃 $S$ 盒的输出差分，而其输入差分可以通过 $B_6=E(L_6),B_6^*=E(L_6^*)$ 计算出来，这样我们得到了攻击 $S$ 盒的三元组 $(B_6,B_6^*, C_6')$，然后我们采用如下攻击流程来攻击第 6 轮轮函数的五个 $S$ 盒：

1. 计算 $C_6'=P^{-1}(R_6' \oplus 04000000_x)$
2. 计算 $B_6 = E(L_6), B_6^*=E(L_6^*)$，然后计算 $B_6'=B_6 \oplus B_6^*$
3. 对于 $i \in \{2, 5, 6, 7, 8\}$，计算子密钥部分比特 $J_i \in KJ_i, KJ_i = IN_S(B_{6,i}', C_{6,i}') \oplus B_{6,i}$

#### 过滤部分错误对

但是和低轮次攻击不同的是，假设输出差分是正确的概率仅为 $1/16$。如果我们从差分特征 $\Omega$ 的正确对开始运作，则正确密钥 $J_i$ 一定在集合 $KJ_i$ 中。但是如果从错误对开始运作，则 $C_j$ 的值将不正确。

考虑如下性质：每个 $S$ 盒的差分分布表中，对于一个给定的输入差分，所以可能的输出差分大概只出现 $75\% \sim80\%$。那么对于 $i \in \{2,5,6,7,8\}$，若 $|KJ_i|=0$，则它一定是一个错误对。5 个 $KJ_i$ 都是正数的概率大概为 $0.8^3 \approx \frac{1}{3}$。因此通过此方法大概可以放弃过滤 $2/3$ 的错误对，经过过滤操作后保留下来的"可能的正确对"的比例大约为 $(1/16)/(1/3)=3/16$。

#### 信噪比

根据差分分析的信噪比公式：

$S/N=\frac{2^{30} * (1/ 16)}{4^5}=2^{16}$

需要明文对的数量为 $m \approx c / p$。根据经验来看，$S/N$ 取较大值时 $c$ 取 $3\sim4$，但是对本攻击来说，$c$ 应该取 $7 \sim 8$ 甚至更大的值。我们取 $m=120$ 个明文对。

#### 计数思路

由于该差分特征是概率的，所有明文对并不一定能都提供正确的候选密钥比特，所以无法像低轮次攻击那样对每个 $S$ 盒分别计数，最好的方法是将五个部分的所有候选比特串在一起。

假设一共有 $N$ 对明文，其中每个正确对提供的候选子密钥比特串中，一定有一个是要寻找的正确密钥串。根据差分特征，这个正确密钥串出现大约 $N/16$ 次，而其他的密钥串比较随机，通常出现的次数少得多。

假设一个"正确对"通过了过滤操作，那么它提供的长度为 30 的比特串 $J_2J_5J_6J_7J_8$ 共有 $\prod_\limits{i \in \{2,5,6,7,8\}}|KJ_i|$ 个，所有的正确对凑成的比特串的数量不是一个小数目。况且采用该计数法的话，需要 $2^{30}$ 个计数器，考虑如何去优化空间。

将其抽象为图论的模型，每个明文对视作顶点，每个顶点都含有 5 个 64 比特的掩码，两个顶点之间有边当且仅当它们的每个 64 比特掩码相与不为 0，求出该图的最大团即可找到正确的密钥比特。**最大团指的是点数最多的完全图（完全图指两两顶点都有边相连的图）**

最大团问题是 NP 难题，但是该问题明文对的数量较少，且保证只存在一个最大团，因此可以采用如下的算法求解：

1. 首先令集合 $P$ 代表当前最大团集合，$Q$ 代表未来的最大团集合，初始时 $P,Q$ 为空；
2. 找最大团个数为 1 的集合，即每个点都作为一个团进入集合 $P$；
3. 尝试增加目前的最大团大小，对于 $P$ 中的每一个团，枚举所有不在该团中的点，判断是否与该团中任意点都有边相连。若找到一个这样的点，就形成一个更大团，若该团不存在于 $Q$ 则加入其中；
4. 删去 $P$ 中的团，将 $Q$ 中的团加入 $P$，清空 $Q$；
5. 重复步骤 3、4，直到更新后 $Q$ 仍为空，则找到了唯一最大团。

第三步加入 $Q$ 时注意去重，例如：$\{1,2\}$ 这个团加入 $3$ 号节点，等价于$\{1,3\}$ 这个团加入 $2$ 号节点。

#### 另一个差分特征

在求出密钥的 30 比特后，通过如下的差分特征可以求出密钥的另外 12 比特，如图8所示：

<img src="https://cdn.jsdelivr.net/gh/Lyhappig/images/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0:%E5%AF%86%E7%A0%81%E5%AD%A6:%E5%AF%86%E7%A0%81%E5%88%86%E6%9E%90:%E5%B7%AE%E5%88%86%E5%88%86%E6%9E%90:DES%E5%B7%AE%E5%88%86%E5%88%86%E6%9E%90-11.png" style="zoom:50%;" />

<center><text><b>图8</b></text></center>

通过该差分特征的攻击，采用与上述相同的攻击手法，可以得到 $S_1,S_2,S_4,S_5,S_6$ 对应的 30 密钥比特信息。

据此我们已经得到了第六轮轮密钥的 42 比特，剩下的 14 比特枚举即可破解得到 DES 的主密钥。

